name: Build and Push job-backup-db Docker Image

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build & Push (multi-arch)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: üõí Checkout source
        uses: actions/checkout@v4

      - name: üß∞ Set up QEMU (for multi-arch emulation)
        uses: docker/setup-qemu-action@v3

      - name: üß± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: üè∑Ô∏è Prepare tags & metadata
        id: meta
        run: |
          echo "DATE=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "SHA_TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          # ‡∏ä‡∏∑‡πà‡∏≠ image ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          echo "IMAGE=ygevo/job-backup-db" >> $GITHUB_OUTPUT

      - name: üèóÔ∏è Build and Push multi-arch Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          # cache ‡∏ó‡∏≥‡πÉ‡∏´‡πâ build ‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
          cache-from: type=registry,ref=${{ steps.meta.outputs.IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.IMAGE }}:buildcache,mode=max
          # ‡πÉ‡∏™‡πà build-args ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡∏á‡πÉ‡∏ô image (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Dockerfile ‡∏Å‡πá ARG ‡πÑ‡∏ß‡πâ)
          build-args: |
            GIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ steps.meta.outputs.DATE }}
            VERSION=${{ steps.meta.outputs.SHA_TAG }}
          tags: |
            ${{ steps.meta.outputs.IMAGE }}:latest
            ${{ steps.meta.outputs.IMAGE }}:${{ steps.meta.outputs.SHA_TAG }}
            ${{ steps.meta.outputs.IMAGE }}:${{ steps.meta.outputs.DATE }}
          # ‡πÉ‡∏™‡πà labels (‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÉ‡∏ô registry)
          labels: |
            org.opencontainers.image.title=job-backup-db
            org.opencontainers.image.description=Monthly PostgreSQL dump (Node.js + node-cron) 
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.DATE }}
